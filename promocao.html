<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vita Septem – Promoção Relâmpago</title>
  <meta name="description" content="Descontos por tempo limitado na Vita Septem. Corra, a promoção termina em breve!" />
  <meta name="theme-color" content="#880c21" />
  <!-- Open Graph -->
  <meta property="og:title" content="Vita Septem – Promoção Relâmpago" />
  <meta property="og:description" content="Ofertas com desconto e tempo limitado. Garanta seu look agora." />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="icon.png" />
  <meta property="og:locale" content="pt_BR" />
  <!-- Fonts & Favicon -->
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="icon" type="image/x-icon" href="icon.ico">

  <style>
    :root{
      --wine:#880c21; --wine-600:#a11837; --black:#0e0e0f; --gray-900:#17171a;
      --gray-800:#1c1c20; --gray-700:#232327; --gray-500:#8c8c94; --white:#ffffff;
      --radius:18px; --shadow:0 10px 30px rgba(0,0,0,.35);
      --success:#25D366;
    }
    *{box-sizing:border-box}
    html{scroll-behavior:smooth}
    body{
      margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--white); background:linear-gradient(180deg,var(--black),var(--gray-900) 35%, #0b0b0c);
      -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
    }
    a{color:inherit; text-decoration:none}
    .container{max-width:1200px; margin:0 auto; padding:0 20px}

    /* Header */
    header{position:sticky; top:0; z-index:70; backdrop-filter:saturate(140%) blur(8px);
      background:rgba(13,13,15,.7); border-bottom:1px solid rgba(255,255,255,.06)}
    .nav{display:flex; align-items:center; justify-content:center; padding:18px 0}
    .brand{display:flex; align-items:center; gap:12px}
    .brand img{height:110px; width:auto; object-fit:contain}

    /* Hero */
    .hero{position:relative; overflow:hidden; isolation:isolate}
    .hero::before{
      content:""; position:absolute; inset:-20%;
      background:
        radial-gradient(80% 60% at 70% 20%, rgba(136,12,33,.35), transparent 60%),
        radial-gradient(60% 40% at 10% 10%, rgba(255,255,255,.08), transparent 60%);
      z-index:-1; filter:blur(10px)
    }
    .hero-grid{display:grid; grid-template-columns:1.1fr .9fr; gap:36px; align-items:center; padding:64px 0}
    .kicker{color:#e9e9ea; letter-spacing:.14em; text-transform:uppercase; font-size:.82rem}
    h1{margin:.35rem 0 1rem; font-family:"Playfair Display",serif; font-weight:700;
       font-size:clamp(2.1rem, 3.2vw + 1rem, 3.6rem); line-height:1.05;}
    .lead{color:#d9d9dd; font-size:1.05rem; max-width:52ch}
    .btn{display:inline-flex; align-items:center; gap:10px; padding:12px 18px; border-radius:14px; font-weight:600;
         background:var(--wine); border:1px solid rgba(255,255,255,.1); box-shadow:var(--shadow);
         transition:transform .15s ease, background .2s ease;}
    .btn:hover{background:var(--wine-600); transform:translateY(-1px)}
    .btn.secondary{background:transparent; border-color:rgba(255,255,255,.18)}
    .btn.ghost{background:#1a1a1e; border:1px solid rgba(255,255,255,.12)}
    .hero-visual{background:linear-gradient(180deg,#141416,#0d0d0f);
      border:1px solid rgba(255,255,255,.08); border-radius:var(--radius); min-height:360px;
      display:grid; place-items:center; position:relative; overflow:hidden}
    .hero-visual img{width:100%; height:100%; object-fit:cover}
    .tag{position:absolute; top:14px; right:14px; padding:6px 10px; border-radius:999px;
      background:rgba(136,12,33,.18); border:1px solid rgba(136,12,33,.5); font-size:.78rem}

    /* Seções & Cards */
    section{padding:56px 0}
    .section-title{font-family:"Playfair Display",serif; font-weight:700; font-size:2rem; margin:0 0 14px}
    .muted{color:#cfcfd6; margin:0 0 26px}
    .grid{display:grid; gap:18px; grid-template-columns:repeat(12,1fr)}
    .card{grid-column:span 4; background:linear-gradient(180deg,#141416,#101013);
      border:1px solid rgba(255,255,255,.08); border-radius:16px; overflow:hidden; transition:transform .15s ease; position:relative}
    .card:hover{transform:translateY(-3px)}
    .card img{width:100%; height:260px; object-fit:cover; background:#0f0f11}
    .card .p{padding:14px 14px 16px}
    .price{display:flex; align-items:center; justify-content:space-between; margin-top:6px; font-variant-numeric:tabular-nums}
    .price s{color:#9a9aa3}
    .price strong{font-size:1.1rem}
    .badge{background:rgba(136,12,33,.22); border:1px solid rgba(136,12,33,.55); padding:4px 10px; border-radius:999px; font-size:.78rem}
    .discount{position:absolute; left:12px; top:12px; background:rgba(37,211,102,.22); border:1px solid rgba(37,211,102,.55); color:#eaffef;
      padding:6px 10px; border-radius:999px; font-weight:700; font-size:.82rem}
    .buy{margin-top:12px; width:100%; text-align:center; padding:10px 12px; border-radius:12px; background:#1a1a1e; border:1px solid rgba(255,255,255,.12)}
    .buy:hover{border-color:rgba(255,255,255,.22)}

    /* Countdown */
    .countdown{display:flex; gap:8px; margin-top:10px; font-variant-numeric:tabular-nums}
    .pill{padding:6px 8px; border:1px solid rgba(255,255,255,.12); border-radius:10px; background:#121214; text-align:center; font-size:.9rem}
    .pill b{display:inline-block; min-width:18px}

    /* WhatsApp FAB */
    .fab{position:fixed; right:18px; bottom:18px; background:var(--success); color:#000; font-weight:700;
      padding:12px 14px; border-radius:999px; box-shadow:var(--shadow); z-index:130}

    /* Footer */
    footer{border-top:1px solid rgba(255,255,255,.08); padding:28px 0 60px; color:#cfcfd6}
    .brand-small{display:flex; gap:10px; align-items:center}
    .brand-small img{width:28px; height:28px}

    /* Responsive */
    @media (max-width: 980px){
      .hero-grid{grid-template-columns:1fr; padding:44px 0}
      .grid .card{grid-column:span 6}
      .brand img{height:76px}
    }
    @media (max-width: 640px){
      .grid .card{grid-column:span 12}
      .brand img{height:64px}
    }
  </style>
</head>
<body>
  <!-- FAB WhatsApp -->
  <a href="https://wa.me/5599981543912?text=Quero%20meu%20look%20Vita%20Septem" class="fab" aria-label="Falar no WhatsApp">WhatsApp</a>

  <!-- Header -->
  <header>
    <div class="container nav">
      <a class="brand" href="index.html#hero" aria-label="Ir para o início">
        <img src="icon2.png" alt="Logo Vita Septem">
      </a>
    </div>
  </header>

  <!-- HERO -->
  <section id="hero" class="hero" aria-label="Promoção Relâmpago">
    <div class="container hero-grid">
      <div>
        <div class="kicker">Promoção • Tempo Limitado</div>
        <h1 id="heroTitle">Promoção Relâmpago</h1>
        <p class="lead" id="heroLead">Descontos selecionados por poucas horas. Corra antes que acabe.</p>

        <!-- Contagem geral até a oferta que termina primeiro -->
        <div style="margin-top:10px">
          <div class="kicker" style="font-size:.78rem; letter-spacing:.1em">Termina em</div>
          <div class="countdown">
            <div class="pill"><b id="DD">00</b>d</div>
            <div class="pill"><b id="HH">00</b>h</div>
            <div class="pill"><b id="MM">00</b>min</div>
            <div class="pill"><b id="SS">00</b>s</div>
          </div>
        </div>

        <div style="display:flex; gap:12px; flex-wrap:wrap; margin-top:18px">
          <a href="#ofertas" class="btn">Ver Ofertas</a>
          <a href="index.html#colecao" class="btn secondary">Ver Coleção</a>
        </div>
      </div>
      <div class="hero-visual" role="img" aria-label="Oferta em destaque">
        <span class="tag" id="heroBadge">Até 30% OFF</span>
        <img id="heroImg" src="https://images.unsplash.com/photo-1503342452485-86ff0a4a9972?q=80&w=1400&auto=format&fit=crop" alt="Oferta destaque Vita Septem">
      </div>
    </div>
  </section>

  <!-- OFERTAS -->
  <section id="ofertas" aria-labelledby="ttl-ofertas">
    <div class="container">
      <h2 class="section-title" id="ttl-ofertas">Ofertas Ativas</h2>
      <p class="muted">Válidas somente até o tempo expirar. O preço volta ao normal depois.</p>

      <div class="grid" id="gridDeals"></div>
      <div id="emptyDeals" class="muted" style="display:none">Sem ofertas no momento.</div>
    </div>
  </section>

  <!-- CONTATO/LOCAL -->
  <section aria-label="Informações de contato e localização">
    <div class="container" style="display:grid; grid-template-columns:1.2fr .8fr; gap:22px">
      <div>
        <h3 class="section-title" style="margin-top:0">Visite a loja</h3>
        <p class="muted">Rua Nova, Centro – São João do Caru / MA<br/>Seg–Sáb: 9h às 19h</p>
        <div style="display:flex; gap:10px; flex-wrap:wrap">
          <a class="btn ghost" href="https://wa.me/5599981543912?text=Quero%20um%20atendimento%20Vita%20Septem">WhatsApp</a>
          <a class="btn ghost" href="https://www.instagram.com/vitaseptem" target="_blank" rel="noopener">Instagram</a>
        </div>
      </div>
      <div aria-hidden="true">
        <iframe title="Mapa da loja" width="100%" height="220" style="border:0; border-radius:14px"
          loading="lazy" referrerpolicy="no-referrer-when-downgrade"
          src="https://www.google.com/maps?q=São%20João%20do%20Caru%20MA&output=embed"></iframe>
      </div>
    </div>
  </section>

  <footer>
    <div class="container" style="display:flex; align-items:center; justify-content:space-between; gap:16px; flex-wrap:wrap">
      <div class="brand-small">
        <img src="icon.png" alt="" aria-hidden="true">
        <span>© <span id="year"></span> Vita Septem – Men’s Fashion</span>
      </div>
      <small>Desenvolvido para performance e conversão.</small>
    </div>
  </footer>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ====== Config ======
    const SUPABASE_URL = "https://dwqkuwqmlhvplmgwksas.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR3cWt1d3FtbGh2cGxtZ3drc2FzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3ODM4NjksImV4cCI6MjA3MDM1OTg2OX0._pFblnBzx5cf0SUfAC_w-kmcdFbidZsh23XKXJR98ng";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth:{ persistSession:false }});

    const BUCKET = "flash"; // bucket público para imagens das ofertas
    const WHATSAPP = "5599981543912";
    document.getElementById('year').textContent = new Date().getFullYear();

    // ===== Helpers =====
    const fmtBRL = (cents)=> (cents/100).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
    function wa(text){
      const url = `https://wa.me/${WHATSAPP}?text=${encodeURIComponent(text)}`;
      window.open(url,'_blank'); return false;
    }
    function storageUrl(path){
      try{
        const { data } = supabase.storage.from(BUCKET).getPublicUrl(path);
        return data.publicUrl || "";
      }catch{ return ""; }
    }
    function imgUrlFrom(img){
      if(!img) return "";
      if(img.url) return img.url;
      if(img.path) return storageUrl(img.path);
      return "";
    }
    function parseDate(d){
      // aceita timestamptz do Supabase/ISO ou número (ms)
      if(!d) return null;
      try{
        if(typeof d === 'number') return new Date(d);
        return new Date(d);
      }catch{ return null; }
    }

    // ===== DOM =====
    const grid = document.getElementById('gridDeals');
    const empty = document.getElementById('emptyDeals');
    const heroImg = document.getElementById('heroImg');
    const heroBadge = document.getElementById('heroBadge');
    const heroTitle = document.getElementById('heroTitle');
    const heroLead = document.getElementById('heroLead');

    const DD = document.getElementById('DD');
    const HH = document.getElementById('HH');
    const MM = document.getElementById('MM');
    const SS = document.getElementById('SS');

    // ===== Countdown geral (menor ends_at) + countdown por card =====
    const timers = new Map(); // el -> timestamp
    let globalEnd = null;

    function setGlobalEnd(ts){
      if(!globalEnd || ts < globalEnd) globalEnd = ts;
    }
    function toParts(diff){
      const d = Math.max(0, diff);
      const days = Math.floor(d/(1000*60*60*24));
      const hours = Math.floor((d%(1000*60*60*24))/(1000*60*60));
      const mins = Math.floor((d%(1000*60*60))/(1000*60));
      const secs = Math.floor((d%(1000*60))/1000);
      return {days, hours, mins, secs};
    }
    function updateCountdowns(){
      const now = Date.now();

      // global
      if(globalEnd){
        const parts = toParts(globalEnd - now);
        DD.textContent = String(parts.days).padStart(2,'0');
        HH.textContent = String(parts.hours).padStart(2,'0');
        MM.textContent = String(parts.mins).padStart(2,'0');
        SS.textContent = String(parts.secs).padStart(2,'0');
      }

      // por card
      timers.forEach((ts, el)=>{
        const diff = ts - now;
        const parts = toParts(diff);
        el.querySelector('[data-cd="d"]').textContent = String(parts.days).padStart(2,'0');
        el.querySelector('[data-cd="h"]').textContent = String(parts.hours).padStart(2,'0');
        el.querySelector('[data-cd="m"]').textContent = String(parts.mins).padStart(2,'0');
        el.querySelector('[data-cd="s"]').textContent = String(parts.secs).padStart(2,'0');
        if(diff <= 0){
          // expirada: desativa CTA e marca
          const cta = el.closest('.card')?.querySelector('.buy');
          if(cta){
            cta.textContent = 'Promo encerrada';
            cta.style.opacity = .6;
            cta.onclick = (ev)=>{ ev.preventDefault(); return false; };
          }
          timers.delete(el);
        }
      });
      requestAnimationFrame(()=> setTimeout(updateCountdowns, 1000));
    }

    // ===== Render =====
    function dealCardTemplate(d){
      const images = (d.flash_images||[]).sort((a,b)=>{
        if((b.is_primary|0)!==(a.is_primary|0)) return (b.is_primary?1:0)-(a.is_primary?1:0);
        return (a.sort_order||100)-(b.sort_order||100);
      });
      const cover = imgUrlFrom(images[0]) || "https://images.unsplash.com/photo-1503342452485-86ff0a4a9972?q=80&w=1400&auto=format&fit=crop";
      const ends = parseDate(d.ends_at)?.getTime() || (Date.now()+36*60*60*1000);
      const price = d.price_cents || 0;
      const compare = d.compare_at_cents || 0;

      // global countdown pega o menor ends
      setGlobalEnd(ends);

      const discount = d.discount_label || (compare>price ? `-${Math.round((1 - price/compare)*100)}%` : '');

      return `
        <article class="card" id="${d.slug}">
          ${discount ? `<span class="discount">${discount}</span>`:``}
          <img src="${cover}" alt="${d.title||'Oferta Vita Septem'}">
          <div class="p">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <h3 style="margin:0">${d.title||'Oferta'}</h3>
              ${d.badge ? `<span class="badge">${d.badge}</span>`:``}
            </div>
            ${d.subtitle ? `<p class="muted" style="margin:6px 0 0">${d.subtitle}</p>`:``}
            <div class="price">
              <div>${compare>price ? `<s>${fmtBRL(compare)}</s>` : ``}</div>
              <strong>${fmtBRL(price)}</strong>
            </div>
            <div class="countdown cd" data-ends="${ends}">
              <div class="pill"><b data-cd="d">00</b>d</div>
              <div class="pill"><b data-cd="h">00</b>h</div>
              <div class="pill"><b data-cd="m">00</b>min</div>
              <div class="pill"><b data-cd="s">00</b>s</div>
            </div>
            <a class="buy" href="#" data-title="${d.title||'Oferta'}" data-price="${price}" onclick="return buy(this)">Comprar com Desconto</a>
          </div>
        </article>
      `;
    }

    function renderDeals(list){
      grid.innerHTML = "";
      if(!list?.length){ empty.style.display='block'; return; }
      empty.style.display='none';

      // herói com a primeira
      const first = list[0];
      const heroImage = imgUrlFrom((first.flash_images||[]).find(i=>i.is_primary) || (first.flash_images||[])[0]) ||
                        "https://images.unsplash.com/photo-1503342452485-86ff0a4a9972?q=80&w=1400&auto=format&fit=crop";
      heroImg.src = heroImage;
      heroBadge.textContent = first.discount_label || heroBadge.textContent;
      heroTitle.textContent = first.title || 'Promoção Relâmpago';
      heroLead.textContent = first.subtitle || 'Descontos selecionados por poucas horas.';

      // cards
      list.forEach(d => grid.insertAdjacentHTML('beforeend', dealCardTemplate(d)));

      // registra contadores por card
      document.querySelectorAll('.cd').forEach(cd=>{
        const ends = Number(cd.getAttribute('data-ends'));
        timers.set(cd, ends);
      });

      updateCountdowns();
    }

    function buy(el){
      const title = el.dataset.title || 'Oferta';
      const price = Number(el.dataset.price||0);
      const link = `${location.href.split('#')[0]}#${el.closest('.card')?.id || ''}`;
      const msg = `Promoção Relâmpago: ${title} por ${(price/100).toLocaleString('pt-BR',{style:'currency',currency:'BRL'})} | Link: ${link}`;
      return wa(msg);
    }
    window.buy = buy;

    // ===== Load Supabase + fallback =====
    async function loadDeals(){
      try{
        // Estrutura esperada:
        // flash_deals { id, slug, title, subtitle, description, price_cents, compare_at_cents, discount_label, ends_at, badge, sort_order, is_active }
        // flash_images { deal_id (FK), url, path, alt, is_primary, sort_order }
        const { data, error } = await supabase
          .from('flash_deals')
          .select(`
            id, slug, title, subtitle, description, price_cents, compare_at_cents, discount_label, ends_at, badge, sort_order, is_active,
            flash_images ( url, path, alt, is_primary, sort_order )
          `)
          .eq('is_active', true)
          .order('sort_order', { ascending: true });

        if(error) throw error;

        if(!data?.length){
          renderDeals(fallbackDeals());
        }else{
          renderDeals(data);
        }
      }catch(err){
        console.warn('Falha ao carregar ofertas:', err?.message);
        renderDeals(fallbackDeals());
      }
    }

    function fallbackDeals(){
      const now = Date.now();
      const in36h = new Date(now + 36*60*60*1000).toISOString();
      const in20h = new Date(now + 20*60*60*1000).toISOString();
      const in8h  = new Date(now +  8*60*60*1000).toISOString();

      return [
        {
          slug:'camisa-oxford-essential',
          title:'Camisa Oxford Essential',
          subtitle:'Caimento impecável e tecido robusto.',
          price_cents:14990, compare_at_cents:19990,
          discount_label:'-25%',
          ends_at: in20h,
          badge:'Relâmpago',
          flash_images:[{url:"https://images.unsplash.com/photo-1503342452485-86ff0a4a9972?q=80&w=1400&auto=format&fit=crop", is_primary:true, sort_order:1}]
        },
        {
          slug:'polo-minimal',
          title:'Polo Minimal',
          subtitle:'Leve e respirável para o dia a dia.',
          price_cents:9990, compare_at_cents:13990,
          discount_label:'-29%',
          ends_at: in36h,
          flash_images:[{url:"https://images.unsplash.com/photo-1519741497674-611481863552?q=80&w=1400&auto=format&fit=crop", is_primary:true, sort_order:1}]
        },
        {
          slug:'chino-comfort',
          title:'Chino Comfort',
          subtitle:'Versátil para trabalho e casual.',
          price_cents:15990, compare_at_cents:18990,
          discount_label:'-16%',
          ends_at: in8h,
          flash_images:[{url:"https://images.unsplash.com/photo-1453873531674-2151bcd01707?q=80&w=1400&auto=format&fit=crop", is_primary:true, sort_order:1}]
        }
      ];
    }

    // start
    loadDeals();
  </script>
</body>
</html>
