<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vita Septem – Clube de Assinatura</title>
  <meta name="description" content="Clube Vita Septem: receba peças exclusivas todo mês, com descontos, frete grátis e brindes. Assine já." />
  <meta name="theme-color" content="#880c21" />
  <!-- Open Graph -->
  <meta property="og:title" content="Vita Septem – Clube de Assinatura" />
  <meta property="og:description" content="Benefícios reais: peças mensais, descontos e frete grátis." />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="icon.png" />
  <meta property="og:locale" content="pt_BR" />
  <!-- Fonts & Favicon -->
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="icon" type="image/x-icon" href="icon.ico">

  <style>
    :root{
      --wine:#880c21; --wine-600:#a11837; --black:#0e0e0f; --gray-900:#17171a;
      --gray-800:#1c1c20; --gray-700:#232327; --gray-600:#34343a; --gray-500:#8c8c94; --white:#ffffff;
      --radius:18px; --shadow:0 10px 30px rgba(0,0,0,.35); --success:#25D366;
      --ok:#30d158; --muted:#cfcfd6;
    }
    *{box-sizing:border-box}
    html{scroll-behavior:smooth}
    body{
      margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--white); background:linear-gradient(180deg,var(--black),var(--gray-900) 35%, #0b0b0c);
      -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
    }
    a{color:inherit; text-decoration:none}
    .container{max-width:1200px; margin:0 auto; padding:0 20px}

    /* Header */
    header{position:sticky; top:0; z-index:70; backdrop-filter:saturate(140%) blur(8px);
      background:rgba(13,13,15,.7); border-bottom:1px solid rgba(255,255,255,.06)}
    .nav{display:flex; align-items:center; justify-content:center; padding:18px 0}
    .brand{display:flex; align-items:center; gap:12px}
    .brand img{height:110px; width:auto; object-fit:contain}

    /* Hero */
    .hero{position:relative; overflow:hidden; isolation:isolate}
    .hero::before{
      content:""; position:absolute; inset:-20%;
      background:
        radial-gradient(80% 60% at 70% 20%, rgba(136,12,33,.35), transparent 60%),
        radial-gradient(60% 40% at 10% 10%, rgba(255,255,255,.08), transparent 60%);
      z-index:-1; filter:blur(10px)
    }
    .hero-grid{display:grid; grid-template-columns:1.1fr .9fr; gap:36px; align-items:center; padding:64px 0}
    .kicker{color:#e9e9ea; letter-spacing:.14em; text-transform:uppercase; font-size:.82rem}
    h1{margin:.35rem 0 1rem; font-family:"Playfair Display",serif; font-weight:700;
       font-size:clamp(2.1rem, 3.2vw + 1rem, 3.6rem); line-height:1.05;}
    .lead{color:#d9d9dd; font-size:1.05rem; max-width:52ch}
    .btn{display:inline-flex; align-items:center; gap:10px; padding:12px 18px; border-radius:14px; font-weight:600;
         background:var(--wine); border:1px solid rgba(255,255,255,.1); box-shadow:var(--shadow);
         transition:transform .15s ease, background .2s ease;}
    .btn:hover{background:var(--wine-600); transform:translateY(-1px)}
    .btn.secondary{background:transparent; border-color:rgba(255,255,255,.18)}
    .btn.ghost{background:#1a1a1e; border:1px solid rgba(255,255,255,.12)}
    .hero-visual{background:linear-gradient(180deg,#141416,#0d0d0f);
      border:1px solid rgba(255,255,255,.08); border-radius:var(--radius); min-height:360px;
      display:grid; place-items:center; position:relative; overflow:hidden}
    .hero-visual img{width:100%; height:100%; object-fit:cover}
    .tag{position:absolute; top:14px; right:14px; padding:6px 10px; border-radius:999px;
      background:rgba(136,12,33,.18); border:1px solid rgba(136,12,33,.5); font-size:.78rem}

    /* Sections */
    section{padding:56px 0}
    .section-title{font-family:"Playfair Display",serif; font-weight:700; font-size:2rem; margin:0 0 14px}
    .muted{color:var(--muted); margin:0 0 26px}
    .grid{display:grid; gap:18px; grid-template-columns:repeat(12,1fr)}

    /* Benefits */
    .benefit{grid-column:span 4; background:linear-gradient(180deg,#141416,#101013);
      border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:16px; min-height:140px}
    .benefit h4{margin:0 0 6px}
    .benefit p{margin:0; color:#dcdce3}

    /* Plans */
    .plan{grid-column:span 4; background:linear-gradient(180deg,#131316,#101013);
      border:1px solid rgba(255,255,255,.10); border-radius:18px; overflow:hidden; position:relative}
    .plan .hdr{padding:18px 16px; border-bottom:1px solid rgba(255,255,255,.08); display:flex; align-items:center; justify-content:space-between}
    .plan .badge{background:rgba(136,12,33,.22); border:1px solid rgba(136,12,33,.55); padding:4px 10px; border-radius:999px; font-size:.78rem}
    .plan .media{height:200px; background:#0f0f11; overflow:hidden}
    .plan .media img{width:100%; height:100%; object-fit:cover}
    .plan .p{padding:14px}
    .plan .price{display:flex; align-items:baseline; gap:10px; font-variant-numeric:tabular-nums}
    .plan .price strong{font-size:1.6rem}
    .plan ul{margin:12px 0 0; padding-left:18px; color:#e9e9ed}
    .plan ul li{margin:6px 0}
    .plan .cta{display:flex; gap:10px; margin-top:14px; flex-wrap:wrap}
    .ok{display:inline-flex; align-items:center; gap:8px}
    .ok i{width:10px; height:10px; background:var(--ok); border-radius:999px; display:inline-block}

    /* Testimonials */
    .testi{display:grid; grid-template-columns:repeat(3,1fr); gap:18px}
    .quote{background:linear-gradient(180deg,#141416,#101013); border:1px solid rgba(255,255,255,.08);
      border-radius:16px; padding:18px; color:#e7e7ea}
    .quote b{display:block; margin-top:10px; color:#fff}
    .stars{letter-spacing:2px}

    /* FAQ */
    details.faq{background:linear-gradient(180deg,#141416,#101013); border:1px solid rgba(255,255,255,.08);
      border-radius:16px; padding:14px 16px}
    details.faq:not(:last-child){margin-bottom:12px}
    details.faq summary{cursor:pointer; font-weight:600}

    /* Modal Assinatura */
    .modal{position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.7); z-index:120}
    .modal.open{display:grid}
    .modal .box{max-width:720px; width:92vw; background:#101013; border:1px solid rgba(255,255,255,.12);
                border-radius:16px; overflow:hidden}
    .modal header{position:relative; background:#121214; border-bottom:1px solid rgba(255,255,255,.08); padding:14px 16px}
    .modal .close{position:absolute; right:12px; top:10px; background:#000; border:1px solid rgba(255,255,255,.25); padding:6px 10px; border-radius:10px; cursor:pointer}
    .modal .content{padding:16px}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .row + .row{margin-top:10px}
    .row input, .row select{
      width:100%; padding:10px 12px; border-radius:12px; background:#121214; color:#fff;
      border:1px solid rgba(255,255,255,.12)
    }
    .agree{display:flex; gap:8px; align-items:flex-start; margin-top:10px; font-size:.92rem; color:#dcdce3}
    .alert{margin-top:10px; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.12); display:none}
    .alert.ok{display:block; background:rgba(48,209,88,.1); border-color:rgba(48,209,88,.4)}
    .alert.err{display:block; background:rgba(255,69,58,.10); border-color:rgba(255,69,58,.45)}

    /* WhatsApp FAB */
    .fab{position:fixed; right:18px; bottom:18px; background:var(--success); color:#000; font-weight:700;
      padding:12px 14px; border-radius:999px; box-shadow:var(--shadow); z-index:130}

    /* Footer */
    footer{border-top:1px solid rgba(255,255,255,.08); padding:28px 0 60px; color:var(--muted)}
    .brand-small{display:flex; gap:10px; align-items:center}
    .brand-small img{width:28px; height:28px}

    /* Responsive */
    @media (max-width: 980px){
      .hero-grid{grid-template-columns:1fr; padding:44px 0}
      .grid .benefit, .grid .plan{grid-column:span 12}
      .testi{grid-template-columns:1fr}
      .brand img{height:76px}
    }
    @media (max-width: 640px){
      .brand img{height:64px}
      .row{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <!-- FAB WhatsApp -->
  <a href="https://wa.me/5599981543912?text=Quero%20assinar%20o%20Clube%20Vita%20Septem" class="fab" aria-label="Falar no WhatsApp">WhatsApp</a>

  <!-- Header -->
  <header>
    <div class="container nav">
      <a class="brand" href="index.html#hero" aria-label="Ir para o início">
        <img src="icon2.png" alt="Logo Vita Septem">
      </a>
    </div>
  </header>

  <!-- HERO -->
  <section id="hero" class="hero" aria-label="Clube de Assinatura">
    <div class="container hero-grid">
      <div>
        <div class="kicker">Clube • Mensal</div>
        <h1>Clube Vita Septem</h1>
        <p class="lead">Receba peças exclusivas todo mês e desbloqueie benefícios: descontos, frete grátis e brindes especiais.</p>
        <div style="display:flex; gap:12px; flex-wrap:wrap; margin-top:22px">
          <a href="#beneficios" class="btn">Ver benefícios</a>
          <a href="#planos" class="btn secondary">Ver planos</a>
        </div>
      </div>
      <div class="hero-visual" role="img" aria-label="Assinatura Vita Septem">
        <span class="tag" id="heroBadge">Peças Exclusivas</span>
        <img id="heroImg" src="https://images.unsplash.com/photo-1520975922284-54243f13c6d1?q=80&w=1600&auto=format&fit=crop" alt="Clube Vita Septem">
      </div>
    </div>
  </section>

  <!-- BENEFÍCIOS -->
  <section id="beneficios" aria-labelledby="ttl-beneficios">
    <div class="container">
      <h2 class="section-title" id="ttl-beneficios">Benefícios do Clube</h2>
      <p class="muted">Mais do que desconto: curadoria mensal e experiência premium.</p>
      <div class="grid" id="benefitsGrid"></div>
    </div>
  </section>

  <!-- PLANOS -->
  <section id="planos" aria-labelledby="ttl-planos">
    <div class="container">
      <h2 class="section-title" id="ttl-planos">Escolha seu plano</h2>
      <p class="muted">Planos pensados para perfis diferentes. Sem letra miúda.</p>
      <div class="grid" id="plansGrid"></div>
      <p class="muted" style="margin-top:10px">Valores mensais. Você pode pausar ou cancelar quando quiser.</p>
    </div>
  </section>

  <!-- DEPOIMENTOS -->
  <section aria-labelledby="ttl-depo">
    <div class="container">
      <h2 class="section-title" id="ttl-depo">O que os membros dizem</h2>
      <div class="testi" id="testiGrid"></div>
    </div>
  </section>

  <!-- FAQ -->
  <section aria-labelledby="ttl-faq">
    <div class="container">
      <h2 class="section-title" id="ttl-faq">Perguntas frequentes</h2>
      <div id="faqList"></div>
    </div>
  </section>

  <!-- CONTATO/LOCAL -->
  <section aria-label="Informações de contato e localização">
    <div class="container" style="display:grid; grid-template-columns:1.2fr .8fr; gap:22px">
      <div>
        <h3 class="section-title" style="margin-top:0">Visite a loja</h3>
        <p class="muted">Rua Nova, Centro – São João do Caru / MA<br/>Seg–Sáb: 9h às 19h</p>
        <div style="display:flex; gap:10px; flex-wrap:wrap">
          <a class="btn ghost" href="https://wa.me/5599981543912?text=Quero%20saber%20sobre%20o%20Clube%20Vita%20Septem">WhatsApp</a>
          <a class="btn ghost" href="https://www.instagram.com/vitaseptem" target="_blank" rel="noopener">Instagram</a>
        </div>
      </div>
      <div aria-hidden="true">
        <iframe title="Mapa da loja" width="100%" height="220" style="border:0; border-radius:14px"
          loading="lazy" referrerpolicy="no-referrer-when-downgrade"
          src="https://www.google.com/maps?q=São%20João%20do%20Caru%20MA&output=embed"></iframe>
      </div>
    </div>
  </section>

  <footer>
    <div class="container" style="display:flex; align-items:center; justify-content:space-between; gap:16px; flex-wrap:wrap">
      <div class="brand-small">
        <img src="icon.png" alt="" aria-hidden="true">
        <span>© <span id="year"></span> Vita Septem – Men’s Fashion</span>
      </div>
      <small>Desenvolvido para performance e conversão.</small>
    </div>
  </footer>

  <!-- MODAL: Assinar -->
  <div class="modal" id="subModal" aria-hidden="true" role="dialog" aria-label="Assinar Clube Vita Septem">
    <div class="box">
      <header>
        <strong id="mTitle">Assinar</strong>
        <button class="close" onclick="closeModal()" aria-label="Fechar">✕</button>
      </header>
      <div class="content">
        <div class="row">
          <input id="mName" type="text" placeholder="Seu nome *" autocomplete="name" />
          <input id="mPhone" type="tel" placeholder="WhatsApp (com DDD) *" autocomplete="tel" />
        </div>
        <div class="row">
          <input id="mEmail" type="email" placeholder="E-mail" autocomplete="email" />
          <select id="mSize">
            <option value="">Tamanho preferido (opcional)</option>
            <option>P</option><option>M</option><option>G</option><option>GG</option>
          </select>
        </div>
        <label class="agree">
          <input id="mAgree" type="checkbox" />
          <span>Concordo em receber contato sobre minha assinatura e comunicações do Clube.</span>
        </label>
        <div id="mAlert" class="alert"></div>
        <div class="cta" style="margin-top:12px">
          <button class="btn" id="mSubmit">Quero assinar</button>
          <button class="btn ghost" onclick="closeModal()">Cancelar</button>
        </div>
        <p class="muted" style="margin-top:8px" id="mNote"></p>
      </div>
    </div>
  </div>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ====== Config ======
    const SUPABASE_URL = "https://dwqkuwqmlhvplmgwksas.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR3cWt1d3FtbGh2cGxtZ3drc2FzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3ODM4NjksImV4cCI6MjA3MDM1OTg2OX0._pFblnBzx5cf0SUfAC_w-kmcdFbidZsh23XKXJR98ng";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth:{ persistSession:false }});

    const BUCKET = "subscriptions"; // bucket público para imagens de planos
    const WHATSAPP = "5599981543912";
    document.getElementById('year').textContent = new Date().getFullYear();

    // ===== Helpers =====
    const fmtBRL = (cents)=> (cents/100).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
    function storageUrl(path){
      try{
        const { data } = supabase.storage.from(BUCKET).getPublicUrl(path);
        return data.publicUrl || "";
      }catch{ return ""; }
    }
    function imgUrlFrom(img){
      if(!img) return "";
      if(img.url) return img.url;
      if(img.path) return storageUrl(img.path);
      return "";
    }
    function star(n){ return '★'.repeat(n) + '☆'.repeat(5-n); }

    // ===== DOM =====
    const benefitsGrid = document.getElementById('benefitsGrid');
    const plansGrid = document.getElementById('plansGrid');
    const testiGrid = document.getElementById('testiGrid');
    const faqList = document.getElementById('faqList');

    const heroImg = document.getElementById('heroImg');
    const heroBadge = document.getElementById('heroBadge');

    // Modal
    const subModal = document.getElementById('subModal');
    const mTitle = document.getElementById('mTitle');
    const mName = document.getElementById('mName');
    const mPhone = document.getElementById('mPhone');
    const mEmail = document.getElementById('mEmail');
    const mSize = document.getElementById('mSize');
    const mAgree = document.getElementById('mAgree');
    const mSubmit = document.getElementById('mSubmit');
    const mAlert = document.getElementById('mAlert');
    const mNote = document.getElementById('mNote');

    let CURRENT_PLAN = null;

    // ===== Benefits =====
    function benefitTemplate(b){
      return `
        <article class="benefit">
          <h4>${b.title||'Benefício'}</h4>
          <p>${b.description||''}</p>
        </article>
      `;
    }

    // ===== Plans =====
    function planTemplate(p){
      const imgs = (p.subscription_plan_images||[]).sort((a,b)=>{
        if((b.is_primary|0)!==(a.is_primary|0)) return (b.is_primary?1:0)-(a.is_primary?1:0);
        return (a.sort_order||100)-(b.sort_order||100);
      });
      const cover = imgUrlFrom(imgs[0]) || "https://images.unsplash.com/photo-1490481651871-ab68de25d43d?q=80&w=1600&auto=format&fit=crop";
      const price = p.price_cents || 0;
      heroBadge.textContent = p.badge || heroBadge.textContent; // usa o 1º plano para hero

      // perks: text[]
      const perks = (p.perks || []).map(txt=>`<li class="ok"><i></i> ${txt}</li>`).join('');

      return `
        <article class="plan" id="${p.slug||''}">
          <div class="hdr">
            <h3 style="margin:0">${p.title||'Plano'}</h3>
            ${p.badge ? `<span class="badge">${p.badge}</span>`:``}
          </div>
          <div class="media"><img src="${cover}" alt="${p.title||'Plano'}" /></div>
          <div class="p">
            ${p.subtitle ? `<p class="muted" style="margin:4px 0 10px">${p.subtitle}</p>`:``}
            <div class="price">
              <strong>${fmtBRL(price)}</strong><span class="muted">/ mês</span>
              ${p.compare_at_cents>price ? `<s class="muted" style="margin-left:8px">${fmtBRL(p.compare_at_cents)}</s>`:``}
              ${p.trial_days ? `<span class="badge" style="margin-left:auto">${p.trial_days} dias de teste</span>`:``}
            </div>
            ${p.shipping_text ? `<p class="muted" style="margin:6px 0 0">${p.shipping_text}</p>`:``}
            ${perks ? `<ul>${perks}</ul>`:``}
            <div class="cta">
              <button class="btn" data-plan='${JSON.stringify({slug:p.slug,title:p.title,price_cents:p.price_cents})}' onclick="openModal(this)">Assinar</button>
              <a class="btn ghost" href="#" onclick="return waPlan('${p.title||'Plano'}', ${price})">Falar no WhatsApp</a>
            </div>
          </div>
        </article>
      `;
    }

    function waPlan(title, price){
      const msg = `Quero assinar o plano: ${title} por ${(price/100).toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}`;
      const url = `https://wa.me/${WHATSAPP}?text=${encodeURIComponent(msg)}`;
      window.open(url,'_blank'); return false;
    }

    // ===== Testimonials =====
    function testiTemplate(t){
      return `
        <div class="quote">
          <div class="stars">${star(Math.max(3, Math.min(5, t.stars||5)))}</div>
          “${t.quote||''}”
          <b>${t.author||'Cliente'}</b>
        </div>
      `;
    }

    // ===== FAQ =====
    function faqTemplate(f){
      return `
        <details class="faq">
          <summary>${f.q||'Pergunta'}</summary>
          <div class="muted" style="margin-top:8px">${f.a||''}</div>
        </details>
      `;
    }

    // ===== Modal logic =====
    function openModal(btn){
      try{
        const data = JSON.parse(btn.getAttribute('data-plan')||'{}');
        CURRENT_PLAN = data;
      }catch{ CURRENT_PLAN = null; }
      const title = CURRENT_PLAN?.title || 'Assinar';
      const price = CURRENT_PLAN?.price_cents || 0;
      mTitle.textContent = `Assinar – ${title}`;
      mNote.textContent = `Plano por ${fmtBRL(price)} / mês. Entraremos em contato para confirmar preferências e envio.`;
      mName.value = ''; mPhone.value = ''; mEmail.value=''; mSize.value=''; mAgree.checked=false;
      mAlert.className='alert'; mAlert.textContent='';
      subModal.classList.add('open'); subModal.setAttribute('aria-hidden','false');
      document.body.style.overflow='hidden';
    }
    function closeModal(){
      subModal.classList.remove('open'); subModal.setAttribute('aria-hidden','true');
      document.body.style.overflow='';
    }
    window.openModal = openModal;
    window.closeModal = closeModal;

    function showAlert(ok, msg){
      mAlert.className = 'alert ' + (ok?'ok':'err');
      mAlert.textContent = msg;
    }

    function validPhone(s){ return /\d{10,13}/.test((s||'').replace(/\D/g,'')); }
    function validEmail(s){ return !s || /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s); }

    mSubmit.onclick = async ()=>{
      const name = mName.value.trim();
      const phone = mPhone.value.trim();
      const email = mEmail.value.trim();
      const size = mSize.value;
      const agreed = mAgree.checked;

      if(!name){ showAlert(false,'Informe seu nome.'); return; }
      if(!validPhone(phone)){ showAlert(false,'Informe um WhatsApp válido com DDD.'); return; }
      if(!validEmail(email)){ showAlert(false,'E-mail inválido.'); return; }
      if(!agreed){ showAlert(false,'É necessário concordar para prosseguir.'); return; }

      const planSlug = CURRENT_PLAN?.slug || null;
      const tag = planSlug ? `clube_vita` : 'clube_vita';
      const msgExtra = size ? ` | tam:${size}` : '';

      try{
        const { error } = await supabase
          .from('leads')
          .insert([{ name, email, phone, tag, launch_slug: planSlug, source:'web' }]); // reutiliza a tabela leads
        if(error) throw error;

        showAlert(true,'Recebemos seu interesse! Em instantes falaremos com você no WhatsApp.');
        // CTA WhatsApp (opcional) para manter o momentum
        setTimeout(()=>{
          const wmsg = `Quero assinar o Clube (${CURRENT_PLAN?.title||'Plano'})${msgExtra}. Meu nome é ${name}.`;
          const url = `https://wa.me/${WHATSAPP}?text=${encodeURIComponent(wmsg)}`;
          window.open(url,'_blank');
        }, 600);
      }catch(err){
        console.warn('Falha ao registrar lead:', err?.message);
        showAlert(false,'Não foi possível enviar agora. Tente novamente ou chame no WhatsApp.');
      }
    };

    // ===== Data loading =====
    async function loadBenefits(){
      try{
        const { data, error } = await supabase
          .from('subscription_benefits')
          .select('id, title, description, sort_order, is_active')
          .eq('is_active', true)
          .order('sort_order', { ascending:true });
        if(error) throw error;
        renderBenefits(data?.length ? data : fallbackBenefits());
      }catch{
        renderBenefits(fallbackBenefits());
      }
    }
    function renderBenefits(list){
      benefitsGrid.innerHTML = '';
      list.forEach(b => benefitsGrid.insertAdjacentHTML('beforeend', benefitTemplate(b)));
    }

    async function loadPlans(){
      try{
        const { data, error } = await supabase
          .from('subscription_plans')
          .select(`
            id, slug, title, subtitle, price_cents, compare_at_cents, badge, perks, trial_days, shipping_text, sort_order, is_active,
            subscription_plan_images ( url, path, alt, is_primary, sort_order )
          `)
          .eq('is_active', true)
          .order('sort_order', { ascending:true });

        if(error) throw error;

        const list = data?.length ? data : fallbackPlans();
        renderPlans(list);

        // hero image com primeira imagem do primeiro plano
        const first = list[0];
        if(first?.subscription_plan_images?.length){
          const sorted = [...first.subscription_plan_images].sort((a,b)=>{
            if((b.is_primary|0)!==(a.is_primary|0)) return (b.is_primary?1:0)-(a.is_primary?1:0);
            return (a.sort_order||100)-(b.sort_order||100);
          });
          const hero = imgUrlFrom(sorted[0]);
          if(hero) heroImg.src = hero;
          if(first.badge) heroBadge.textContent = first.badge;
        }
      }catch{
        const list = fallbackPlans();
        renderPlans(list);
      }
    }
    function renderPlans(list){
      plansGrid.innerHTML = '';
      list.forEach(p => plansGrid.insertAdjacentHTML('beforeend', planTemplate(p)));
    }

    async function loadTestimonials(){
      try{
        const { data, error } = await supabase
          .from('subscription_testimonials')
          .select('id, author, quote, stars, sort_order, is_active')
          .eq('is_active', true)
          .order('sort_order', { ascending:true });
        if(error) throw error;
        renderTesti(data?.length ? data : fallbackTesti());
      }catch{
        renderTesti(fallbackTesti());
      }
    }
    function renderTesti(list){
      testiGrid.innerHTML = '';
      list.forEach(t => testiGrid.insertAdjacentHTML('beforeend', testiTemplate(t)));
    }

    async function loadFaq(){
      try{
        const { data, error } = await supabase
          .from('subscription_faqs')
          .select('id, q, a, sort_order, is_active')
          .eq('is_active', true)
          .order('sort_order', { ascending:true });
        if(error) throw error;
        renderFaq(data?.length ? data : fallbackFaq());
      }catch{
        renderFaq(fallbackFaq());
      }
    }
    function renderFaq(list){
      faqList.innerHTML = '';
      list.forEach(f => faqList.insertAdjacentHTML('beforeend', faqTemplate(f)));
    }

    // ===== Fallbacks =====
    function fallbackBenefits(){
      return [
        { title:'Peça mensal exclusiva', description:'Receba 1 peça curada pela equipe Vita Septem todo mês.' },
        { title:'Frete grátis', description:'Envio sem custo nas caixas do Clube.' },
        { title:'Descontos extras', description:'Até 20% OFF em compras fora do Clube.' },
        { title:'Troca facilitada', description:'Primeira troca grátis em cada caixa mensal.' },
        { title:'Acesso antecipado', description:'Coleções e lançamentos antes do público.' },
        { title:'Brindes surpresa', description:'Mimos e acessórios em meses selecionados.' }
      ];
    }
    function fallbackPlans(){
      return [
        {
          slug:'essencial', title:'Essencial', subtitle:'Para começar com o pé direito.',
          price_cents:12990, compare_at_cents:0, badge:'Popular',
          perks:['1 peça curada/mês','Frete grátis','5% OFF no site','Troca fácil'],
          trial_days:7, shipping_text:'Envio entre dias 5–10 de cada mês.',
          subscription_plan_images:[{url:'https://images.unsplash.com/photo-1515378791036-0648a3ef77b2?q=80&w=1600&auto=format&fit=crop', is_primary:true, sort_order:1}]
        },
        {
          slug:'premium', title:'Premium', subtitle:'Upgrade no guarda-roupa.',
          price_cents:18990, compare_at_cents:0, badge:'Mais Benefícios',
          perks:['1 peça premium/mês','Frete grátis','10% OFF no site','Acesso antecipado','Brinde trimestral'],
          trial_days:10, shipping_text:'Envio entre dias 5–10 de cada mês.',
          subscription_plan_images:[{url:'https://images.unsplash.com/photo-1520975916090-3105956dac38?q=80&w=1600&auto=format&fit=crop', is_primary:true, sort_order:1}]
        },
        {
          slug:'black', title:'Black', subtitle:'Experiência completa.',
          price_cents:24990, compare_at_cents:0, badge:'Exclusivo',
          perks:['1 peça edição especial/mês','Frete grátis','20% OFF no site','Acesso VIP','Brinde mensal'],
          trial_days:14, shipping_text:'Envio entre dias 5–10 de cada mês.',
          subscription_plan_images:[{url:'https://images.unsplash.com/photo-1490481651871-ab68de25d43d?q=80&w=1600&auto=format&fit=crop', is_primary:true, sort_order:1}]
        }
      ];
    }
    function fallbackTesti(){
      return [
        { author:'João V.', quote:'“Recebo todo mês algo que realmente uso. Valeu demais.”', stars:5 },
        { author:'Rafael M.', quote:'“Custo-benefício real. A polo premium do Black é absurda!”', stars:5 },
        { author:'Daniel S.', quote:'“Frete grátis e brinde me ganharam. Atendimento rápido.”', stars:4 }
      ];
    }
    function fallbackFaq(){
      return [
        { q:'Como funciona a cobrança?', a:'Cobrança mensal via link de pagamento enviado após a confirmação. Você pode pausar ou cancelar quando quiser.' },
        { q:'Posso trocar o tamanho?', a:'Sim. A primeira troca de cada caixa mensal é gratuita.' },
        { q:'Quando recebo a peça?', a:'As caixas são enviadas entre os dias 5 e 10 de cada mês.' },
        { q:'Posso escolher a peça?', a:'Você informa preferências; nossa curadoria seleciona a melhor opção para seu perfil.' }
      ];
    }

    // ===== Start =====
    function wa(text){
      const url = `https://wa.me/${WHATSAPP}?text=${encodeURIComponent(text)}`;
      window.open(url,'_blank'); return false;
    }
    window.waPlan = waPlan;

    async function start(){
      await Promise.all([loadBenefits(), loadPlans(), loadTestimonials(), loadFaq()]);
    }
    start();
  </script>
</body>
</html>
