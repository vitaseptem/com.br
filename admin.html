<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Dashboard • Vita Points | Vita Septem</title>
  <meta name="theme-color" content="#880c21"/>
  <link rel="icon" href="icon.ico" type="image/x-icon"/>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet"/>
  <style>
    :root{ --wine:#880c21; --wine-600:#a11837; --black:#0e0e0f; --gray-900:#17171a; --gray-800:#1a1a1e; --gray-700:#232327; --gray-600:#2a2a2f; --gray-500:#6b6b72; --white:#fff; --radius:16px; --shadow:0 10px 30px rgba(0,0,0,.35); --ok:#21d07a; --warn:#e2b93b; --danger:#ff5d5d; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--white); background:linear-gradient(180deg,var(--black),var(--gray-900) 35%, #0b0b0c)}
    a{color:inherit; text-decoration:none}

    /* Topbar */
    header{position:sticky; top:0; z-index:40; backdrop-filter:saturate(140%) blur(8px); background:rgba(13,13,15,.7); border-bottom:1px solid rgba(255,255,255,.06)}
    .topbar{max-width:1280px; margin:0 auto; padding:14px 20px; display:flex; align-items:center; gap:12px}
    .brand{display:flex; align-items:center; gap:10px}
    .brand img{height:40px}
    .brand b{font-family:"Playfair Display",serif; font-size:1.1rem}
    .topbar .grow{flex:1}
    .search{display:flex; gap:8px; align-items:center; background:#131316; border:1px solid rgba(255,255,255,.08); padding:8px 10px; border-radius:12px; min-width:280px}
    .search input{background:transparent; border:none; outline:0; color:#fff; width:100%}
    .btn{display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:12px; font-weight:600; border:1px solid rgba(255,255,255,.14); background:#19191d; cursor:pointer}
    .btn.primary{background:var(--wine); border-color:rgba(255,255,255,.12)}
    .btn:hover{filter:brightness(1.06)}

    /* Layout */
    .layout{max-width:1280px; margin:20px auto; padding:0 20px; display:grid; grid-template-columns:320px 1fr; gap:18px}
    .panel{background:linear-gradient(180deg,#141416,#101013); border:1px solid rgba(255,255,255,.08); border-radius:var(--radius); overflow:hidden}
    .panel .p{padding:16px}
    .headline{font-family:"Playfair Display",serif; font-size:1.3rem; margin:0 0 10px}
    .muted{color:#cfcfd6}

    .list{max-height:70vh; overflow:auto; border-top:1px solid rgba(255,255,255,.06)}
    .row{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 14px; border-bottom:1px solid rgba(255,255,255,.06); cursor:pointer}
    .row:hover{background:#15151a}
    .row.active{background:#1a1a20}
    .tag{background:rgba(136,12,33,.22); border:1px solid rgba(136,12,33,.55); padding:3px 8px; border-radius:999px; font-size:.78rem}

    .grid-2{display:grid; grid-template-columns:1fr 1fr; gap:14px}
    .grid-3{display:grid; grid-template-columns:repeat(3,1fr); gap:14px}

    .field{display:flex; flex-direction:column; gap:6px}
    .field label{font-size:.9rem; color:#e9e9ea}
    .input, select{width:100%; padding:10px 12px; border-radius:12px; background:#121214; color:#fff; border:1px solid rgba(255,255,255,.12); outline:none}
    .input:focus, select:focus{border-color:rgba(255,255,255,.26)}

    table{width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border-radius:14px; border:1px solid rgba(255,255,255,.08)}
    th,td{padding:10px 12px; border-bottom:1px solid rgba(255,255,255,.06); text-align:left}
    th{background:#161618; font-weight:600}
    tr:last-child td{border-bottom:none}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .danger{color:var(--danger)}

    .statgrid{display:grid; grid-template-columns:repeat(4,1fr); gap:12px}
    .stat{background:#15151a; border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:12px}
    .stat b{display:block; font-size:1.2rem}

    /* Login overlay */
    .loginWrap{position:fixed; inset:0; display:grid; place-items:center; background:radial-gradient(60% 60% at 50% 40%, rgba(136,12,33,.15), transparent 60%), linear-gradient(180deg,var(--black),var(--gray-900)); z-index:100}
    .loginCard{width:min(720px,92vw); background:linear-gradient(180deg,#151517,#111114); border:1px solid rgba(255,255,255,.08); border-radius:22px; padding:24px; box-shadow:var(--shadow)}
    .loginHead{display:flex; gap:12px; align-items:center; justify-content:center; margin-bottom:8px}
    .loginHead img{height:56px}
    .loginHead h1{font-family:"Playfair Display",serif; font-size:1.6rem; margin:0}
    .loginGrid{display:grid; grid-template-columns:1fr 1fr; gap:16px}
    .loginFoot{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-top:12px}
    .hint{font-size:.9rem; color:#cfcfd6}
    @media (max-width:860px){ .loginGrid{grid-template-columns:1fr} }

    /* QR Scanner modal */
    .modal{position:fixed; inset:0; background:rgba(0,0,0,.65); display:none; align-items:center; justify-content:center; z-index:90}
    .modalBox{width:min(560px,92vw); background:#0f0f12; border:1px solid rgba(255,255,255,.1); border-radius:18px; padding:16px}
    .modalHead{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:8px}
    .closeX{background:#19191d; border:1px solid rgba(255,255,255,.15); border-radius:10px; padding:6px 10px; cursor:pointer}

    @media (max-width:1000px){ .layout{grid-template-columns:1fr} .list{max-height:none} .statgrid{grid-template-columns:repeat(2,1fr)} }
  </style>
</head>
<body>
  <!-- LOGIN OVERLAY -->
  <div id="loginWrap" class="loginWrap" hidden>
    <div class="loginCard">
      <div class="loginHead">
        <img src="icon.png" alt="Vita Septem"/>
        <h1>Vita Points – Admin</h1>
      </div>
      <p class="hint" style="text-align:center; margin:0 0 12px">Acesse com seu usuário de staff para gerenciar pontos e resgates.</p>
      <div class="loginGrid">
        <div class="field">
          <label for="admEmail">E-mail</label>
          <input id="admEmail" type="email" class="input" placeholder="admin@vitaseptem.com" autocomplete="username"/>
        </div>
        <div class="field">
          <label for="admPass">Senha</label>
          <input id="admPass" type="password" class="input" placeholder="••••••••" autocomplete="current-password"/>
        </div>
      </div>
      <div class="loginFoot">
        <div id="loginMsg" class="hint">—</div>
        <div style="display:flex; gap:8px">
          <button id="btnLogin" class="btn primary">Entrar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- TOPBAR -->
  <header>
    <div class="topbar">
      <div class="brand"><img src="icon.png" alt=""><b>Vita Points – Admin</b></div>
      <div class="grow">
        <div class="search">
          <input id="q" placeholder="Buscar por nome ou nº do cartão (01–32767)">
          <button id="btnBuscar" class="btn">Buscar</button>
          <button id="btnClear" class="btn">Limpar</button>
          <button id="btnScan" class="btn">Escanear QR</button>
        </div>
      </div>
      <button id="btnOverview" class="btn">Atualizar</button>
      <button id="btnExport" class="btn">Exportar CSV</button>
      <button id="btnSair" class="btn">Sair</button>
    </div>
  </header>

  <!-- QR SCANNER MODAL -->
  <div id="qrModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="qrTitle">
    <div class="modalBox">
      <div class="modalHead">
        <h3 id="qrTitle" class="headline" style="margin:0">Escanear QR do cartão</h3>
        <button class="closeX" id="btnCloseScan">Fechar</button>
      </div>
      <div id="qrRegion" style="width:100%"></div>
      <div style="display:flex; gap:8px; align-items:center; justify-content:space-between; margin-top:10px">
        <div class="hint" id="scanMsg">Autorize a câmera para iniciar.</div>
        <div style="display:flex; gap:8px">
          <select id="camList" class="input" style="min-width:200px"></select>
          <button id="btnStartScan" class="btn primary">Iniciar</button>
          <button id="btnStopScan" class="btn" disabled>Parar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MAIN LAYOUT -->
  <main class="layout">
    <aside class="panel" id="panelList">
      <div class="p">
        <h3 class="headline">Clientes</h3>
        <div class="muted" id="listHint">—</div>
      </div>
      <div class="list" id="list"></div>
    </aside>

    <section class="panel" id="panelMain">
      <div class="p">
        <h3 class="headline">Resumo</h3>
        <div class="statgrid" id="stats">
          <div class="stat"><small>Total de clientes</small><b id="stMembers">0</b></div>
          <div class="stat"><small>Pontos totais</small><b id="stPoints">0</b></div>
          <div class="stat"><small>Ganhos (todos os tempos)</small><b id="stEarned">0</b></div>
          <div class="stat"><small>Resgatados</small><b id="stSpent">0</b></div>
        </div>
      </div>
      <div class="p">
        <h3 class="headline">Detalhes do cliente</h3>
        <div class="grid-3">
          <div class="field"><label>Nome</label><input id="mName" class="input" placeholder="—"></div>
          <div class="field"><label>Nº do cartão</label><input id="mNo" class="input" disabled></div>
          <div class="field"><label>Pontos</label><input id="mPoints" class="input" disabled></div>
        </div>
        <div class="grid-3" style="margin-top:10px">
          <div class="field"><label>VIP</label>
            <select id="mVip" class="input"><option value="false">Cliente</option><option value="true">VIP</option></select>
          </div>
          <div class="field"><label>Data de nascimento</label><input id="mBirth" type="date" class="input"></div>
          <div class="field"><label>Telefone</label><input id="mPhone" class="input" placeholder="(98) 9 XXXX-XXXX"></div>
        </div>
        <div style="display:flex; gap:10px; margin-top:12px; flex-wrap:wrap">
          <button id="btnSalvarPerfil" class="btn primary">Salvar perfil</button>
          <span id="msgPerfil" class="muted"></span>
        </div>
      </div>

      <div class="p">
        <h3 class="headline">Operações</h3>
        <div class="grid-3">
          <div class="field">
            <label>Creditar por compra (R$)</label>
            <input id="opCompraValor" class="input" inputmode="decimal" placeholder="0,00">
            <button id="btnCompra" class="btn primary" style="margin-top:8px">Aplicar regra (1 ponto a cada R$10)</button>
          </div>
          <div class="field">
            <label>Adicionar/Estornar pontos</label>
            <input id="opDelta" class="input" inputmode="numeric" placeholder="Ex.: 10 ou -5">
            <button id="btnDelta" class="btn" style="margin-top:8px">Lançar delta</button>
          </div>
          <div class="field">
            <label>Ajustar para valor exato</label>
            <input id="opSet" class="input" inputmode="numeric" placeholder="Ex.: 120">
            <button id="btnSet" class="btn" style="margin-top:8px">Ajustar saldo</button>
          </div>
        </div>
        <div class="grid-3" style="margin-top:12px">
          <div class="field">
            <label>Resgatar recompensa</label>
            <select id="opReward" class="input">
              <option value="R050|50">R050 • 10% OFF (50 pts)</option>
              <option value="R100|100">R100 • Camiseta básica (100 pts)</option>
              <option value="R150|150">R150 • Polo/Calça 20% OFF (150 pts)</option>
              <option value="R200|200">R200 • Camisa premium (200 pts)</option>
              <option value="R300|300">R300 • Vale R$200 (300 pts)</option>
            </select>
            <input id="opRewardNote" class="input" placeholder="Obs. do resgate" style="margin-top:8px">
            <button id="btnResgatar" class="btn" style="margin-top:8px">Resgatar</button>
          </div>
          <div class="field">
            <label>Motivo/Descrição</label>
            <input id="opMotivo" class="input" placeholder="Ex.: Compra balcão #123">
          </div>
          <div class="field">
            <label>Status</label>
            <div id="opMsg" class="muted" style="padding:10px 0">—</div>
          </div>
        </div>
      </div>

      <div class="p">
        <h3 class="headline">Histórico de pontos</h3>
        <table>
          <thead><tr><th>Quando</th><th>Δ Pontos</th><th>Motivo</th><th>Valor R$</th><th>Mult.</th><th>Por</th></tr></thead>
          <tbody id="log"></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>

  <script>
    // ==== CONFIG SUPABASE ====
    const SUPABASE_URL = "https://dwqkuwqmlhvplmgwksas.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR3cWt1d3FtbGh2cGxtZ3drc2FzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3ODM4NjksImV4cCI6MjA3MDM1OTg2OX0._pFblnBzx5cf0SUfAC_w-kmcdFbidZsh23XKXJR98ng";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
    });

    // ==== HELPERS ====
    const $ = (id)=>document.getElementById(id);
    const fmtBRL = (n)=> (n==null?"": Number(n).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}));
    const fmtInt = (v)=>Number(v||0).toLocaleString('pt-BR');
    const pad5 = (n)=> String(n).padStart(5,'0');

    let overview = []; let current = null;

    function setInfo(el, msg, tone=""){
      if(!el) return; el.textContent = msg || "";
      el.style.color = tone==="error"?"#ff8080": tone==="ok"?"#a2f3c9":"#cfcfd6";
    }

    // ==== LOGIN FLOW ====
    async function gate(){
      const { data:{ session } } = await supabase.auth.getSession();
      if(!session){ showLogin(); return; }
      hideLogin();
      try{ await loadOverview(); }catch(e){ showLogin('Sem permissão. Confirme que seu usuário está em staff como admin.'); }
    }

    function showLogin(msg){
      $('loginWrap').hidden = false; setInfo($('loginMsg'), msg||'—');
    }
    function hideLogin(){ $('loginWrap').hidden = true; }

    $('btnLogin').addEventListener('click', async ()=>{
      const email = $('admEmail').value.trim();
      const password = $('admPass').value.trim();
      setInfo($('loginMsg'),'Entrando...');
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if(error){ setInfo($('loginMsg'), 'E-mail ou senha inválidos.', 'error'); return; }
      setInfo($('loginMsg'), 'OK! Carregando...', 'ok');
      hideLogin(); await loadOverview();
    });

    $('btnSair').addEventListener('click', async ()=>{ await supabase.auth.signOut(); location.reload(); });

    // ==== OVERVIEW & LIST ====
    async function loadOverview(){
      const { data, error } = await supabase.rpc('admin_get_members_overview');
      if(error){ console.error(error); throw error; }
      overview = data||[]; renderList(overview);
      const total = overview.length;
      const sumPoints = overview.reduce((a,b)=>a+(b.points||0),0);
      const earned = overview.reduce((a,b)=>a+(b.total_earned||0),0);
      const spent = overview.reduce((a,b)=>a+(b.total_spent||0),0);
      $('stMembers').textContent = fmtInt(total);
      $('stPoints').textContent = fmtInt(sumPoints);
      $('stEarned').textContent = fmtInt(earned);
      $('stSpent').textContent = fmtInt(spent);
      $('listHint').textContent = `${fmtInt(total)} cliente(s)`;
    }

    function renderList(list){
      const box = $('list'); box.innerHTML = '';
      list.sort((a,b)=> (a.member_no||0)-(b.member_no||0));
      list.forEach(m=>{
        const row = document.createElement('div');
        row.className = 'row'; row.dataset.id = m.id;
        row.innerHTML = `
          <div><b>${pad5(m.member_no)}</b> — ${m.name||'—'}</div>
          <div class="tag">${m.points||0} pts</div>`;
        row.onclick = ()=>selectMember(m.id);
        box.appendChild(row);
      });
    }

    function markActive(id){ document.querySelectorAll('.row').forEach(r=> r.classList.toggle('active', r.dataset.id===id)); }

    async function selectMember(id){
      markActive(id);
      const { data:mem, error } = await supabase.from('members').select('*').eq('id', id).maybeSingle();
      if(error||!mem){ alert('Não foi possível carregar o cliente.'); return; }
      current = mem;
      $('mName').value = mem.name||'';
      $('mNo').value = pad5(mem.member_no);
      $('mPoints').value = mem.points||0;
      $('mVip').value = mem.is_vip? 'true':'false';
      $('mBirth').value = mem.birthdate? new Date(mem.birthdate).toISOString().slice(0,10): '';
      $('mPhone').value = mem.phone||'';
      await loadLog(id);
    }

    async function loadLog(member_id){
      const { data, error } = await supabase.from('points_log')
        .select('created_at, delta, reason, value_brl, bonus_mult, performed_by')
        .eq('member_id', member_id)
        .order('created_at', { ascending:false })
        .limit(50);
      if(error){ console.error(error); return; }
      const tbody = $('log'); tbody.innerHTML = '';
      (data||[]).forEach(r=>{
        const d = new Date(r.created_at);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${d.toLocaleString('pt-BR')}</td>
          <td class="${r.delta>=0?'ok':'danger'}">${r.delta>0?'+':''}${r.delta}</td>
          <td>${r.reason||''}</td>
          <td>${r.value_brl? fmtBRL(r.value_brl): ''}</td>
          <td>${r.bonus_mult||1}</td>
          <td>${r.performed_by? String(r.performed_by).slice(0,8): ''}</td>`;
        tbody.appendChild(tr);
      });
    }

    // ==== PERFIL ====
    async function salvarPerfil(){
      if(!current) return;
      const upd = {
        name: $('mName').value.trim(),
        phone: $('mPhone').value.trim() || null,
        is_vip: $('mVip').value === 'true',
        birthdate: $('mBirth').value? $('mBirth').value: null
      };
      const { error } = await supabase.from('members').update(upd).eq('id', current.id);
      if(error){ $('msgPerfil').textContent = 'Erro ao salvar.'; $('msgPerfil').style.color = '#ff8080'; return; }
      $('msgPerfil').textContent = 'Perfil salvo.'; $('msgPerfil').style.color = '#a2f3c9';
      await selectMember(current.id); await loadOverview();
    }

    // ==== OPERAÇÕES ====
    function parseMoneyBR(v){ if(!v) return 0; const n = String(v).replace(/\./g,'').replace(',', '.').replace(/[^0-9.-]/g,''); const num = Number(n); return isNaN(num)?0:num; }

    async function opCompra(){
      if(!current) return; const val = parseMoneyBR($('opCompraValor').value);
      if(val<=0){ $('opMsg').textContent = 'Informe um valor positivo.'; return; }
      const motivo = $('opMotivo').value || 'Compra';
      const { data, error } = await supabase.rpc('admin_add_purchase_points', { p_member_id: current.id, p_amount_brl: val, p_reason: motivo });
      if(error){ $('opMsg').textContent = 'Erro: sem permissão ou RPC indisponível.'; $('opMsg').style.color = '#ff8080'; return; }
      $('opMsg').textContent = `OK: +${data||0} ponto(s).`;
      $('opMsg').style.color = '#a2f3c9'; await selectMember(current.id); await loadOverview();
    }

    async function opDelta(){
      if(!current) return; const delta = parseInt($('opDelta').value,10);
      if(isNaN(delta) || delta===0){ $('opMsg').textContent = 'Informe um número (ex.: 10 ou -5).'; return; }
      const motivo = $('opMotivo').value || (delta>0? 'Crédito manual':'Estorno manual');
      const { error } = await supabase.rpc('admin_add_points', { p_member_id: current.id, p_delta: delta, p_reason: motivo, p_value_brl: 0, p_bonus_mult: 1 });
      if(error){ $('opMsg').textContent = 'Erro ao lançar delta.'; $('opMsg').style.color = '#ff8080'; return; }
      $('opMsg').textContent = `OK: ${delta>0?'+':''}${delta} ponto(s).`;
      $('opMsg').style.color = '#a2f3c9'; await selectMember(current.id); await loadOverview();
    }

    async function opSet(){
      if(!current) return; const alvo = parseInt($('opSet').value,10);
      if(isNaN(alvo) || alvo<0){ $('opMsg').textContent = 'Informe um inteiro ≥ 0.'; return; }
      const motivo = $('opMotivo').value || 'Ajuste manual';
      const { data, error } = await supabase.rpc('admin_set_points', { p_member_id: current.id, p_new_points: alvo, p_reason: motivo });
      if(error){ $('opMsg').textContent = 'Erro ao ajustar.'; $('opMsg').style.color = '#ff8080'; return; }
      $('opMsg').textContent = `OK: diferença aplicada ${data>0?'+':''}${data}`;
      $('opMsg').style.color = '#a2f3c9'; await selectMember(current.id); await loadOverview();
    }

    async function opResgatar(){
      if(!current) return; const parts = ($('opReward').value||'').split('|');
      const code = parts[0]; const cost = parseInt(parts[1]||'0',10); const note = $('opRewardNote').value || '';
      const { error } = await supabase.rpc('admin_redeem_reward', { p_member_id: current.id, p_reward_code: code, p_points_cost: cost, p_note: note });
      if(error){ $('opMsg').textContent = 'Erro ao resgatar (pontos insuficientes ou permissão).'; $('opMsg').style.color = '#ff8080'; return; }
      $('opMsg').textContent = `OK: resgate ${code} (-${cost} pts).`;
      $('opMsg').style.color = '#a2f3c9'; await selectMember(current.id); await loadOverview();
    }

    function exportCSV(){
      if(!overview.length){ alert('Nada para exportar.'); return; }
      const cols = ['id','name','phone','member_no','points','is_vip','birthdate','created_at','total_earned','total_spent','last_activity'];
      const lines = [cols.join(';')];
      overview.forEach(r=>{ const row = cols.map(k=> (r[k]??'')).join(';'); lines.push(row); });
      const blob = new Blob(["\ufeff"+lines.join('\n')], {type:'text/csv;charset=utf-8'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
      a.download = `vita-points-overview-${new Date().toISOString().slice(0,10)}.csv`;
      a.click(); URL.revokeObjectURL(a.href);
    }

    // ==== BUSCA & ATALHOS ====
    async function doSearch(){
      const q = $('q').value.trim();
      if(!q){ renderList(overview); $('listHint').textContent = `${fmtInt(overview.length)} cliente(s)`; return; }
      const { data, error } = await supabase.rpc('admin_search_members', { q });
      if(error){ console.error(error); return; }
      const merged = (data||[]).map(m=> ({...m, total_earned:0, total_spent:0}));
      $('listHint').textContent = `${fmtInt(merged.length)} resultado(s)`;
      renderList(merged);
    }

    // ==== QR SCANNER ====
    let html5scanner = null; let activeCamId = null; let cams = [];

    function parseMemberNoFromQR(text){
      try{
        const url = new URL(text); const p = url.searchParams.get('mn');
        if(p){ const n = parseInt(String(p).replace(/\D/g,''),10); if(n>=1 && n<=32767) return n; }
      }catch(_){}
      const digits = String(text).match(/\d{1,5}/); if(digits){ const n = parseInt(digits[0],10); if(n>=1 && n<=32767) return n; }
      return null;
    }

    async function openScan(){
      $('qrModal').style.display = 'flex'; $('scanMsg').textContent = 'Buscando câmeras...'; $('btnStartScan').disabled = true; $('btnStopScan').disabled = true; $('camList').innerHTML = '';
      try{
        cams = await Html5Qrcode.getCameras();
        if(!cams.length){ $('scanMsg').textContent = 'Nenhuma câmera encontrada.'; return; }
        cams.forEach((c,i)=>{ const opt = document.createElement('option'); opt.value = c.id; opt.textContent = c.label || `Câmera ${i+1}`; $('camList').appendChild(opt); });
        const back = cams.find(c=>/back|traseira|rear/i.test(c.label||''));
        activeCamId = back? back.id : cams[0].id; $('camList').value = activeCamId;
        $('scanMsg').textContent = 'Pronto para iniciar.'; $('btnStartScan').disabled = false;
      }catch(err){ $('scanMsg').textContent = 'Erro ao obter câmeras. Autorize o acesso.'; console.error(err); }
    }

    async function startScan(){
      if(html5scanner){ await stopScan(); }
      html5scanner = new Html5Qrcode('qrRegion');
      $('btnStartScan').disabled = true; $('btnStopScan').disabled = false; $('scanMsg').textContent = 'Escaneando...';
      try{
        await html5scanner.start(
          { deviceId: { exact: $('camList').value } },
          { fps: 10, qrbox: 220 },
          onScanSuccess,
          (err)=>{/* ignore decode errors */}
        );
      }catch(e){ $('scanMsg').textContent = 'Falha ao iniciar câmera.'; $('btnStartScan').disabled = false; $('btnStopScan').disabled = true; console.error(e); }
    }

    async function stopScan(){
      if(html5scanner){ try{ await html5scanner.stop(); await html5scanner.clear(); }catch(_){} html5scanner = null; }
      $('btnStartScan').disabled = false; $('btnStopScan').disabled = true; $('scanMsg').textContent = 'Parado.';
    }

    function closeScan(){ stopScan(); $('qrModal').style.display = 'none'; }

    async function onScanSuccess(decodedText){
      $('scanMsg').textContent = 'QR lido. Processando...';
      const num = parseMemberNoFromQR(decodedText);
      if(!num){ $('scanMsg').textContent = 'QR inválido. Tente novamente.'; return; }
      $('q').value = String(num);
      await doSearch();
      closeScan();
      // se veio um único match, já seleciona
      const firstRow = document.querySelector('.list .row');
      if(firstRow){ firstRow.click(); }
    }

    // ==== INIT ====
    async function init(){
      await gate();
      $('btnOverview').onclick = loadOverview;
      $('btnExport').onclick = exportCSV;
      $('btnBuscar').onclick = doSearch;
      $('btnClear').onclick = ()=>{ $('q').value=''; renderList(overview); $('listHint').textContent = `${fmtInt(overview.length)} cliente(s)`; };

      $('btnCompra').onclick = opCompra;
      $('btnDelta').onclick = opDelta;
      $('btnSet').onclick = opSet;
      $('btnResgatar').onclick = opResgatar;
      $('btnSalvarPerfil').onclick = salvarPerfil;

      $('q').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ doSearch(); } });

      // Scanner handlers
      $('btnScan').onclick = openScan;
      $('btnCloseScan').onclick = closeScan;
      $('camList').onchange = (e)=>{ activeCamId = e.target.value; };
      $('btnStartScan').onclick = startScan;
      $('btnStopScan').onclick = stopScan;
    }

    init();
  </script>
</body>
</html>

